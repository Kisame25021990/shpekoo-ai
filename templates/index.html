<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shpekoo-AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Shpekoo-AI</h1>
        
        <div class="stats">
            <div>
                <span id="knowledge-count">0</span> connaissances
                <span id="ai-status" style="margin-left: 20px;"></span>
            </div>
            <button id="agent-toggle" onclick="toggleAgentMode()" style="padding: 6px 12px; font-size: 12px;">Mode Agent: OFF</button>
        </div>

        <div class="chat-box" id="chat-box"></div>

        <div class="input-section">
            <input type="text" id="question-input" placeholder="Pose une question..." />
            <button onclick="askQuestion()">Demander</button>
        </div>

        <div class="teach-section" id="teach-section" style="display:none;">
            <h3>üéì Apprends-moi !</h3>
            <textarea id="answer-input" placeholder="√âcris la r√©ponse..."></textarea>
            <button onclick="teachAI()">Enseigner</button>
            <button onclick="cancelTeach()">Annuler</button>
        </div>

        <div class="load-section">
            <h3>üìñ Charger des Documents</h3>
            <input type="text" id="url-input" placeholder="URL d'un site web..." />
            <button onclick="loadFromURL()">Charger depuis URL</button>
            <br><br>
            <input type="text" id="folder-input" placeholder="Chemin du dossier (ex: /home/user/projet)..." />
            <button onclick="loadFromFolder()">üìÅ Charger un dossier</button>
            <br><br>
            <textarea id="text-input" placeholder="Ou colle du texte ici..."></textarea>
            <button onclick="loadFromText()">Charger le texte</button>
        </div>

        <div class="knowledge-section">
            <h3>üìö Connaissances</h3>
            <button onclick="showKnowledge()">Voir tout</button>
            <div id="knowledge-list"></div>
        </div>
    </div>

    <script>
        let currentQuestion = '';

        async function askQuestion() {
            const input = document.getElementById('question-input');
            const question = input.value.trim();
            
            if (!question) return;

            addMessage('Toi: ' + question, 'user');
            input.value = '';

            const response = await fetch('/ask', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({question})
            });

            const result = await response.json();

            if (result.found) {
                let source = 'ü§ñ Mod√®le IA';
                if (result.source === 'memory') source = 'üíæ M√©moire';
                if (result.source === 'agent') source = '‚öôÔ∏è Agent';
                
                const formattedAnswer = formatMarkdown(result.answer);
                addMessageHTML(`IA [${source}]: ${formattedAnswer}`, 'ai');
            } else {
                addMessage('IA: Je ne sais pas encore. Tu veux m\'apprendre ?', 'ai');
                currentQuestion = question;
                document.getElementById('teach-section').style.display = 'block';
            }

            updateStats();
        }

        async function teachAI() {
            const answer = document.getElementById('answer-input').value.trim();
            
            if (!answer) return;

            const response = await fetch('/learn', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({question: currentQuestion, answer})
            });

            const result = await response.json();
            addMessage('IA: ' + result.message + ' ‚úÖ', 'ai success');
            
            document.getElementById('teach-section').style.display = 'none';
            document.getElementById('answer-input').value = '';
            updateStats();
        }

        function cancelTeach() {
            document.getElementById('teach-section').style.display = 'none';
            document.getElementById('answer-input').value = '';
        }

        async function showKnowledge() {
            const response = await fetch('/knowledge');
            const knowledge = await response.json();
            
            const list = document.getElementById('knowledge-list');
            list.innerHTML = '';
            
            knowledge.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'knowledge-item';
                div.innerHTML = `
                    <strong>Q:</strong> ${item.question}<br>
                    <strong>R:</strong> ${item.answer}
                    <button onclick="forgetKnowledge('${item.question}')">üóëÔ∏è</button>
                `;
                list.appendChild(div);
            });
        }

        async function forgetKnowledge(question) {
            const response = await fetch('/forget', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({question})
            });

            const result = await response.json();
            addMessage('IA: ' + result.message, 'ai');
            showKnowledge();
            updateStats();
        }

        async function updateStats() {
            const response = await fetch('/stats');
            const stats = await response.json();
            document.getElementById('knowledge-count').textContent = stats.total_knowledge;
            
            const statusEl = document.getElementById('ai-status');
            if (stats.ai_model_available) {
                statusEl.innerHTML = '‚úÖ Mod√®le IA actif';
                statusEl.style.color = '#4caf50';
            } else {
                statusEl.innerHTML = '‚ö†Ô∏è Mod√®le IA non disponible';
                statusEl.style.color = '#ff9800';
            }
            
            // Update agent button
            const agentBtn = document.getElementById('agent-toggle');
            if (stats.agent_mode) {
                agentBtn.textContent = 'Mode Agent: ON';
                agentBtn.style.background = '#238636';
            } else {
                agentBtn.textContent = 'Mode Agent: OFF';
                agentBtn.style.background = '#6e7681';
            }
        }
        
        async function toggleAgentMode() {
            const response = await fetch('/toggle-agent', {
                method: 'POST'
            });
            const result = await response.json();
            
            if (result.agent_mode) {
                addMessage('‚öôÔ∏è Mode Agent activ√© - L\'IA peut maintenant ex√©cuter des actions', 'ai success');
            } else {
                addMessage('üö´ Mode Agent d√©sactiv√© - L\'IA ne fera que r√©pondre', 'ai');
            }
            
            updateStats();
        }

        function addMessage(text, className) {
            const chatBox = document.getElementById('chat-box');
            const msg = document.createElement('div');
            msg.className = 'message ' + className;
            msg.textContent = text;
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addMessageHTML(html, className) {
            const chatBox = document.getElementById('chat-box');
            const msg = document.createElement('div');
            msg.className = 'message ' + className;
            msg.innerHTML = html;
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function formatMarkdown(text) {
            // Convertit les blocs de code
            text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            // Convertit le code inline
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Convertit les sauts de ligne
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        async function loadFromURL() {
            const input = document.getElementById('url-input');
            const url = input.value.trim();
            
            if (!url) return;

            addMessage('‚è≥ Chargement en cours...', 'ai');

            const response = await fetch('/load-url', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url})
            });

            const result = await response.json();

            if (result.success) {
                addMessage(`‚úÖ ${result.message}`, 'ai success');
                input.value = '';
            } else {
                addMessage(`‚ùå Erreur: ${result.error}`, 'ai');
            }

            updateStats();
        }

        async function loadFromText() {
            const input = document.getElementById('text-input');
            const text = input.value.trim();
            
            if (!text) return;

            addMessage('‚è≥ Analyse du texte...', 'ai');

            const response = await fetch('/load-text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text})
            });

            const result = await response.json();

            if (result.success) {
                addMessage(`‚úÖ ${result.message}`, 'ai success');
                input.value = '';
            } else {
                addMessage(`‚ùå Erreur: ${result.error}`, 'ai');
            }

            updateStats();
        }

        async function loadFromFolder() {
            const input = document.getElementById('folder-input');
            const folder_path = input.value.trim();
            
            if (!folder_path) return;

            addMessage('‚è≥ Chargement du dossier...', 'ai');

            const response = await fetch('/load-folder', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({folder_path})
            });

            const result = await response.json();

            if (result.success) {
                addMessage(`‚úÖ ${result.message}`, 'ai success');
                input.value = '';
            } else {
                addMessage(`‚ùå Erreur: ${result.error}`, 'ai');
            }

            updateStats();
        }

        document.getElementById('question-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') askQuestion();
        });

        updateStats();
    </script>
</body>
</html>
